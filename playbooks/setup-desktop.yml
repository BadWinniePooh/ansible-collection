---
- hosts: all
  tags: not-supported-on-vagrant-docker
  become: true

  vars:
    ansible_user: "{{ my_hetzner_config.ansible_user.name }}"
    desktop_user_names: "{{ desktop_users | map(attribute='name') | list }}"

  pre_tasks:
    # TODO: smell - Update apt cache is duplicate in several playbooks
    - name: Update apt cache (if older than 1 hour)
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600

  handlers:
    # TODO: smell - cleanup apt cache is duplicate in several playbooks
    - name: Cleanup apt cache
      apt:
        autoremove: yes
        autoclean: yes

    - name: Restart XRDP
      service:
        name: xrdp
        state: restarted

  tasks:
    - name: Install console utilities
      apt:
        name:
          - curl
          - tree
          - unzip
        state: present
      notify: Cleanup apt cache

    - name: Install minimal GNOME desktop
      apt:
        name:
          - dbus-x11
#          - ubuntu-desktop-minimal
          - python3-full
        state: present
      notify: Cleanup apt cache

    - name: Install XFCE extras and developer tools
      apt:
        name:
          - build-essential
          - gh
          - libsecret-tools
          - seahorse
        state: present
      notify: Cleanup apt cache

    - name: Install .NET SDK
      apt:
        name:
          - dotnet-sdk-8.0
          - dotnet-sdk-10.0
        state: present
      notify: Cleanup apt cache

    - name: Install fnm (Fast Node Manager) for {{ desktop_user_names | join(', ') }}
      ansible.builtin.shell:
        cmd: curl -fsSL https://fnm.vercel.app/install | bash
        creates: "/home/{{ item }}/.local/share/fnm/fnm"
      become_user: "{{ item }}"
      loop: "{{ desktop_user_names }}"

    - name: Install Node 24 via fnm for {{ desktop_user_names | join(', ') }}
      ansible.builtin.shell:
        cmd: ~/.local/share/fnm/fnm install 24
      register: fnm_node_install
      changed_when: "'Downloading' in fnm_node_install.stdout"
      become_user: "{{ item }}"
      loop: "{{ desktop_user_names }}"

    - name: Install Claude Code CLI for {{ desktop_user_names | join(', ') }}
      ansible.builtin.shell:
        cmd: curl -fsSL https://claude.ai/install.sh | bash
        creates: "/home/{{ item }}/.local/bin/claude"
      become_user: "{{ item }}"
      loop: "{{ desktop_user_names }}"

    - name: Install VS Code
      community.general.snap:
        name: code
        classic: true
        state: present

    - name: Remove GNOME remote desktop
      apt:
        name: gnome-remote-desktop
        state: absent
      notify: Cleanup apt cache
    
    - name: Install XFCE desktop and XRDP
      apt:
        name:
          - xfce4
          - xfce4-goodies
          - xrdp
        state: present
      notify: Cleanup apt cache

    - name: Start and enable XRDP
      service:
        name: xrdp
        state: started
        enabled: yes

    - name: Remove light-locker
      apt:
        name: light-locker
        state: absent
      notify: Cleanup apt cache

    - name: Enable XFCE session for {{ desktop_user_names | join(', ') }}
      lineinfile:
        dest: "/home/{{ item }}/.xsession"
        regexp: '^.*'
        line: xfce4-session
        create: yes
        owner: "{{ item }}"
        group: "{{ item }}"
        mode: 0644
        state: present
      loop: "{{ desktop_user_names }}"
      notify: Restart XRDP