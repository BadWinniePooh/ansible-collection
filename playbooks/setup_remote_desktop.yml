---
- name: Set up remote desktop (XRDP) on webservers
  hosts: webservers
  gather_facts: true

  handlers:
    - name: Restart xrdp
      ansible.builtin.service:
        name: xrdp
        state: restarted

    - name: Cleanup apt cache
      ansible.builtin.apt:
        autoremove: true
        autoclean: true

  tasks:
    - name: Update apt cache (if older than 1 hour)
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600

    - name: Install xfce4 desktop and xrdp
      ansible.builtin.apt:
        name:
          - xfce4
          - xfce4-goodies
          - xrdp
        state: present
      notify: Cleanup apt cache

    - name: Remove gnome-remote-desktop (conflicts with xrdp on Ubuntu 24.04)
      ansible.builtin.apt:
        name: gnome-remote-desktop
        state: absent
      notify: Cleanup apt cache

    - name: Remove light-locker (causes black screen over RDP in xfce4)
      ansible.builtin.apt:
        name: light-locker
        state: absent
      notify: Cleanup apt cache

    - name: Configure xrdp to use xfce4 session
      ansible.builtin.lineinfile:
        dest: /root/.xsession
        regexp: '^.*'
        line: xfce4-session
        create: true
        owner: root
        group: root
        mode: "0644"
        state: present
      notify: Restart xrdp

    - name: Add xrdp user to ssl-cert group
      ansible.builtin.user:
        name: xrdp
        groups: ssl-cert
        append: true

    - name: Enable and start xrdp service
      ansible.builtin.service:
        name: xrdp
        state: started
        enabled: true

    - name: Allow SSH through ufw (prevent lockout)
      ansible.builtin.command:
        cmd: ufw allow 22/tcp
      register: ufw_ssh
      changed_when: "'Rules updated' in ufw_ssh.stdout"

    - name: Allow RDP port 3389 through ufw
      ansible.builtin.command:
        cmd: ufw allow 3389/tcp
      register: ufw_rdp
      changed_when: "'Rules updated' in ufw_rdp.stdout"

    - name: Enable ufw
      ansible.builtin.command:
        cmd: ufw --force enable
      changed_when: false
